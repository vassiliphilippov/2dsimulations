<html>
<head>
  <title>Test 16: Tin hedgehog</title>
  <script src="../matter.js"></script>
  <script src="../force.js"></script>
  <script src="../zonemap.js"></script>
  <script src="../background.js"></script>
  <script src="../debug.js"></script>
  <script src="../chemistryparticles.json"></script>
  <script src="../chemistrycompoundstructures.js"></script>
  <script src="../atomcolors.json"></script>
  <script src="../periodictable.json"></script>
  <script src="../chemistry.js"></script>
  <script src="../particles.js"></script>
  <script src="../temperature.js"></script>
  <script src="../chemistryrender.js"></script>
  <script src="../proximity.js"></script>
  <script src="../textureloader.js"></script>
  <script src="../scenario.js"></script>
  <script src="../animation.js"></script>
</head>
<body>
<script>


var engine = null;

ZoneMap.load("map16.png", function (zoneMap) {
    Chemistry.spaceScale = 0.10;
    Chemistry.timeScale = 6e-15;
    const colorZnAtom = "#5E6182";
    const colorZnIon = "#C1C5F2";
    const colorSnAtom = "#668080";
    const colorSnIon = "#A3CCCC";
    const znZoomBounds = ZoneMap.getBounds(zoneMap, "181,230,29");

    function numberOfCloseZnParticles(p) {
        let width = p.bounds.max.x - p.bounds.min.x;
        let height = p.bounds.max.y - p.bounds.min.y; 
        let extendedBound = {
            min: {x: p.bounds.min.x-width, y: p.bounds.min.y-height},
            max: {x: p.bounds.max.x+width, y: p.bounds.max.y+height}
        };
        let countZn = new ParticleList(engine).formula("Zn").inBounds(extendedBound).length()-1;    
        let countSn = new ParticleList(engine).formula("Sn").inBounds(extendedBound).length()-1;    
        return countZn+countSn*2;
    }

    function freeZnComporator(a, b) {
        return numberOfCloseZnParticles(a)-numberOfCloseZnParticles(b);
    }

    [engine, render] = Chemistry.createAndInitEngineAndRender(zoneMap, document.body, true);

    new ParticleList(engine).setTemperature(297);
    new ParticleList(engine).formula("Sn+2").setColor(colorSnIon);
    new ParticleList(engine).formula("Sn+2", "Cl-").setChemistryOptions({brownianMotion: {medium: "water"}});
    let runner = Chemistry.run(engine, render);

    ChemistryRender.lookAt(render, [ZoneMap.getBounds(zoneMap, "230,101,2"), ZoneMap.getBounds(zoneMap, "100,231,2")]);

    scenario = new Scenario(engine, render);

    scenario.addWait(150);

    scenario.addRemoveAnimation(20, engine.world, () => {
        return new ParticleList(engine).formula("H2O");
    });

    scenario.addWait(50);

    scenario.addRemoveAnimation(20, engine.world, () => {
        return new ParticleList(engine).formula("Cl-");
    });

    scenario.addWait(50);

    scenario.addAction(() => {
        new BodyList(engine).zoneMapColor("230,101,2","100,231,2").remove(engine.world);
    });

    scenario.addLookAtAnimation([ZoneMap.getBounds(zoneMap, "230,100,4"), ZoneMap.getBounds(zoneMap, "100,230,4")], 50);

    scenario.addWait(100);

    scenario.addLookAtAnimation(znZoomBounds, 20);

    scenario.addAction(() => {
        let attractor = new AttractorList(engine).getFirst();
        new ParticleList(engine).formula("Sn+2").closest(attractor).first().addAttraction(attractor, 0.01);
    });

    let znToIon = null;
    scenario.addOnCollision("Sn+2_Zn", (event, pSn, pZn) => {
        return Matter.Bounds.overlaps(pZn.bounds, znZoomBounds) && Matter.Bounds.overlaps(pSn.bounds, znZoomBounds)
    }, (event, pSn, pZn) => {
        znToIon = new ParticleList(engine).visible(render).formula("Zn").sortByNumberOfCloseParticles().first();
        znToIon.setColor(colorZnIon);
        ParticleList.create([pSn]).setColor(colorSnAtom);
        pSn.plugin.chemistry.formula = "Sn";
        Chemistry.stick(pSn);
    });

    scenario.addAction(() => {
        new BodyList(engine).zoneMapColor("230,101,2","100,231,2").remove(engine.world);
        runner.enabled = false;
    });

    scenario.addWait(150);

    scenario.addAction(() => {
        runner.enabled = true;
        znToIon.setFormula("Zn+2").unstick({medium: "water"});
    });

    scenario.addWait(50);

    scenario.addLookAtAnimation([ZoneMap.getBounds(zoneMap, "230,100,4"), ZoneMap.getBounds(zoneMap, "100,230,4")], 50);

    scenario.addOnCollision("Sn+2_Zn", null, (event, pSn, pZn) => {
        ParticleList.create([pSn]).setColor(colorSnAtom);
        pSn.plugin.chemistry.formula = "Sn";
        Chemistry.stick(pSn);
        Animation.highlight(engine, render, pSn.position, 100);
        runner.enabled = false;
    });

    scenario.addWait(100);

    scenario.addAction(() => {
        znToIon = new ParticleList(engine).visible(render).formula("Zn").sortByNumberOfCloseParticles().first();
        znToIon.setColor(colorZnIon).setFormula("Zn+2").unstick({medium: "water"});
        Animation.highlight(engine, render, znToIon.getFirst().position, 100);
    });

    scenario.addWait(100);

    scenario.run(() => {
        console.log("Scenario end!");
        runner.enabled = true;
        Matter.Events.on(engine, "collision_Sn+2_Zn", event => {
            pSn = event.particleB;
            ParticleList.create([pSn]).setColor(colorSnAtom).setFormula("Sn").stick();

            let znToIon = new ParticleList(engine).formula("Zn").sort(freeZnComporator).first();
            znToIon.setColor(colorZnIon).setFormula("Zn+2").unstick({medium: "water"});
        });
        Matter.Events.on(engine, "collision_Sn_Sn+2", event => {
            pSn = event.particleB;
            ParticleList.create([pSn]).setColor(colorSnAtom).setFormula("Sn").stick();

            let znToIon = new ParticleList(engine).formula("Zn").sort(freeZnComporator).first();
            znToIon.setColor(colorZnIon).setFormula("Zn+2").unstick({medium: "water"});
        });
    });
});

</script>
<p>
  Tin hedgehog experiment.
</p>
</body>
</html>